<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Matrix → Pixel Art + Player (niveles predefinidos)</title>
<style>
  :root{
    --bg:#f6f9ff; --panel:#ffffff; --ink:#0b1f3b; --muted:#5b7fa3; --border:#d6e6ff;
    --grid:rgba(15,31,59,.08); --accent:#0f172a; --danger:#b91c1c; --success:#065f46;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.45 system-ui,Segoe UI,Inter,Roboto,Arial,sans-serif;display:grid;grid-template-rows:auto 1fr;gap:12px;}
  header{padding:14px 18px;background:linear-gradient(180deg,#fff,rgba(255,255,255,.85));border-bottom:1px solid var(--border);}
  h1{margin:0;font-size:18px}
  main{display:grid;grid-template-columns:520px 1fr;gap:14px;padding:0 14px 18px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 18px rgba(10,30,60,.06);}
  .panel{padding:14px}
  .row{display:grid;grid-template-columns:1fr auto;gap:8px;align-items:end;margin-bottom:10px}
  .row-actions{display:flex;gap:8px;align-items:center;justify-content:flex-end}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  label{font-size:14px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="number"], textarea, input[type="text"], select{
    width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;
    font:14px/1.35 ui-monospace,Menlo,Consolas,monospace;color:var(--ink)
  }
  textarea{min-height:140px;resize:vertical}
  button{padding:9px 12px;border:1px solid var(--border);border-radius:12px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
  button.secondary{background:#fff;color:var(--accent)}
  button:disabled{opacity:.6;cursor:not-allowed}
  .hint{font-size:13px;color:var(--muted)}
  .legend{display:flex;gap:12px;flex-wrap:wrap;font-size:14px;margin-top:8px}
  .swatch{display:inline-flex;align-items:center;gap:6px}
  .box{width:18px;height:18px;border-radius:4px;border:1px solid var(--border);background:#fff;display:grid;place-items:center}
  .icon{width:16px;height:16px;object-fit:contain}
  .error{margin-top:8px;color:var(--danger);font-size:14px}
  .banner{margin-top:10px;padding:10px;border-radius:10px;border:1px solid var(--border);display:none}
  .banner.show{display:block}
  .banner.success{color:#065f46;background:#ecfdf5;border-color:#a7f3d0}
  .banner.fail{color:#991b1b;background:#fef2f2;border-color:#fecaca}
  .status{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .pill{padding:4px 10px;border-radius:999px;border:1px solid var(--border);font-size:13px;background:#fff}
  canvas{width:100%;height:100%;display:block;border-radius:14px;background:#fff;border:1px solid var(--border)}
  .small{font-size:13px;color:var(--muted);margin-top:8px}

  /* Overlay sobre el mapa */
  .stage{position:relative}
  .overlay{
    position:absolute; left:50%; top:12px; transform:translateX(-50%);
    display:none; align-items:center; gap:10px;
    background:rgba(255,255,255,.95);
    border:1px solid var(--border); padding:10px 14px; border-radius:12px;
    box-shadow:0 8px 20px rgba(10,30,60,.12);
    color:var(--success); font-weight:700; pointer-events:none; /* no bloquea clicks */
  }
  .overlay.show{display:flex}
</style>
</head>
<body>
  <header><h1>Matrix → Pixel Art + Player</h1></header>

  <main>
    <!-- Controles -->
    <section class="card panel" aria-label="Controles">
      <div class="row">
        <div>
          <label for="size">n (matriz n×n)</label>
          <input id="size" type="number" min="1" max="100" value="10" />
        </div>
        <button id="build" class="secondary" title="Generar plantilla demo">Crear plantilla</button>
      </div>

      <div class="row">
        <div>
          <label for="levelSelect">Nivel predefinido</label>
          <select id="levelSelect">
            <option value="" selected>— seleccionar nivel —</option>
            <option value="3x3">3×3</option>
            <option value="4x4">4×4</option>
            <option value="5x5">5×5</option>
            <option value="6x6">6×6</option>
            <option value="7x7">7×7</option>
            <option value="8x8">8×8</option>
            <option value="9x9">9×9</option>
            <option value="10x10">10×10</option>
          </select>
        </div>
        <div class="row-actions">
          <button id="render">Render</button>
          <button id="download" class="secondary">Descargar PNG</button>
        </div>
      </div>

      <div>
        <label for="matrix">Matriz (puedes editarla manualmente)</label>
        <textarea id="matrix" spellcheck="false"></textarea>
        <div class="hint">Valores: 0=suelo, 1=pared (bloquea), 2=moneda, 3=fuego (letal), 4=agua (letal)</div>
      </div>

      <div class="row">
        <div>
          <label for="tileSize">Tamaño de celda (px)</label>
          <input id="tileSize" type="number" min="6" max="80" step="2" value="28" />
        </div>
        <div class="row-actions">
          <button id="play">Jugar (animado)</button>
          <button id="restart" class="secondary" style="display:none">Reiniciar</button>
        </div>
      </div>

      <!-- Controles del jugador -->
      <div class="grid3">
        <div>
          <label for="startVec">Inicio (x,y) — 1-based; usa 0 si prefieres 0-based</label>
          <input id="startVec" type="text" value="2,2" />
        </div>
        <div>
          <label for="movesVec">Movimiento (1↑,2→,3↓,4←). Ej: 2,2,3,1</label>
          <input id="movesVec" type="text" value="2,2,3,3,4,4,1,1" />
        </div>
        <div>
          <label for="playerSel">Jugador</label>
          <select id="playerSel">
            <option value="0" selected>player0.png</option>
            <option value="1">player1.png</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <label for="stepMs">Duración por paso (ms)</label>
          <input id="stepMs" type="number" min="30" max="2000" step="10" value="150" />
        </div>
        <div class="status">
          <span class="pill">Puntaje: <span id="score">0</span></span>
          <span class="pill">Monedas restantes: <span id="coinsLeft">0</span></span>
          <span class="pill">Estado: <span id="stateTxt">listo</span></span>
        </div>
      </div>

      <div id="msg" class="banner"></div>
      <div id="error" class="error" role="alert" aria-live="polite"></div>

      <div class="legend" aria-label="Leyenda">
        <span class="swatch"><span class="box"><img class="icon" src="src/imgs/ground.png" alt="ground"/></span>0: Suelo</span>
        <span class="swatch"><span class="box"><img class="icon" src="src/imgs/wall.png" alt="wall"/></span>1: Pared</span>
        <span class="swatch"><span class="box"><img class="icon" src="src/imgs/coin.png" alt="coin"/></span>2: Moneda</span>
        <span class="swatch"><span class="box"><img class="icon" src="src/imgs/fire.png" alt="fire"/></span>3: Fuego</span>
        <span class="swatch"><span class="box"><img class="icon" src="src/imgs/water.png" alt="water"/></span>4: Agua</span>
        <span class="swatch"><span class="box"><img class="icon" src="src/imgs/player0.png" alt="player0"/></span>Jugador 0</span>
        <span class="swatch"><span class="box"><img class="icon" src="src/imgs/player1.png" alt="player1"/></span>Jugador 1</span>
      </div>
    </section>

    <!-- Lienzo -->
    <section class="card panel" aria-label="Lienzo">
      <div class="stage">
        <canvas id="canvas" width="800" height="800"></canvas>
        <div id="overlay" class="overlay" aria-live="polite">Mapa completo — ¡Bien hecho!</div>
      </div>
      <div class="small">El jugador se dibuja encima. Paredes/fuego/agua ocupan la celda completa.</div>
    </section>
  </main>

<script>
/* ---------------- Niveles predefinidos ---------------- */
const PRESET_LEVELS = {
  "3x3": [
    [4,3,0],
    [2,2,2],
    [3,0,1],
  ],
  "4x4": [
    [2,2,1,0],
    [0,2,2,3],
    [0,0,4,0],
    [2,1,3,0],
  ],
  "5x5": [
    [4,0,0,0,4],
    [2,3,2,2,2],
    [0,0,0,0,0],
    [3,0,1,3,4],
    [4,2,4,0,4],
  ],
  "6x6": [
    [3,3,3,0,0,1],
    [1,0,0,3,2,4],
    [1,0,3,4,2,3],
    [1,0,0,4,2,3],
    [2,2,2,2,2,0],
    [0,0,4,1,1,0],
  ],
  "7x7": [
    [2,3,4,3,1,0,0],
    [0,4,0,4,2,0,0],
    [0,4,0,4,3,0,0],
    [0,1,3,4,4,1,0],
    [0,0,0,0,0,1,2],
    [4,3,4,0,4,0,2],
    [3,3,2,2,2,2,2],
  ],
  "8x8": [
    [2,2,2,2,2,2,2,0],
    [2,0,0,0,4,0,0,0],
    [0,1,0,0,4,0,0,1],
    [4,4,0,1,3,0,4,0],
    [3,0,1,4,1,0,0,3],
    [1,1,4,4,0,0,3,0],
    [2,3,1,0,0,3,0,0],
    [0,0,0,0,4,4,3,4],
  ],
  "9x9": [
    [0,3,4,2,0,0,4,3,0],
    [3,1,0,4,0,4,3,4,0],
    [2,3,1,3,0,0,0,0,0],
    [2,0,3,0,4,1,3,0,4],
    [2,1,0,1,1,4,0,0,0],
    [2,0,0,0,0,0,4,0,3],
    [2,3,0,3,4,0,0,0,0],
    [2,0,4,0,3,1,4,4,0],
    [2,0,0,3,4,1,0,0,0],
  ],
  "10x10": [
    [4,3,2,2,2,2,2,4,0,2],
    [4,0,0,4,1,0,2,3,0,0],
    [1,0,0,3,0,3,2,1,3,0],
    [4,4,1,1,1,0,2,0,0,0],
    [3,4,0,4,0,0,2,1,0,1],
    [2,4,0,0,0,3,2,4,0,0],
    [0,0,0,0,3,0,2,4,3,4],
    [3,3,1,0,0,0,2,3,0,1],
    [4,4,0,0,1,1,2,1,0,3],
    [2,0,0,3,0,0,2,0,4,3],
  ],
};

/* ---------------- Parsing helpers ---------------- */
function parseMatrix(text, n){
  const lines=text.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
  if(n == null){
    const L = lines.length;
    const matrix = lines.map((line,r)=>{
      const cells=line.split(/[,\s]+/).filter(Boolean);
      if(cells.length!==L) throw new Error(`El mapa no es cuadrado: fila ${r+1} tiene ${cells.length} valores, esperado ${L}.`);
      return cells.map((v,c)=>{
        const num=Number(v);
        if(![0,1,2,3,4].includes(num)) throw new Error(`Valor inválido "${v}" en fila ${r+1}, col ${c+1}.`);
        return num;
      });
    });
    return matrix;
  } else {
    if(lines.length!==n) throw new Error(`Se esperaban ${n} filas, recibidas ${lines.length}.`);
    return lines.map((line,r)=>{
      const cells=line.split(/[,\s]+/).filter(Boolean);
      if(cells.length!==n) throw new Error(`Fila ${r+1}: se esperaban ${n} valores, recibidos ${cells.length}.`);
      return cells.map((v,c)=>{
        const num=Number(v);
        if(![0,1,2,3,4].includes(num)) throw new Error(`Valor inválido "${v}" en fila ${r+1}, col ${c+1}.`);
        return num;
      });
    });
  }
}
function clampInt(v, min, max){ if(!Number.isFinite(v)) return min; v=Math.round(v); return Math.max(min, Math.min(max, v)); }
function deepCopy(m){ return m.map(row=>row.slice()); }
function parseVec2(s){
  const parts=s.split(/[,\s]+/).map(t=>t.trim()).filter(Boolean).map(Number);
  if(parts.length<2 || !parts.every(Number.isFinite)) throw new Error('Inicio inválido. Usa "x,y".');
  return {x:Math.round(parts[0]), y:Math.round(parts[1])};
}
function parseMoves(s){
  if(!s.trim()) return [];
  const arr=s.split(/[,\s]+/).map(t=>t.trim()).filter(Boolean).map(Number);
  if(!arr.every(v=>[1,2,3,4].includes(v))) throw new Error('Movimiento inválido. Solo 1,2,3,4.');
  return arr;
}

/* ---------------- Canvas helpers ---------------- */
function resizeCanvasForMatrix(canvas,n,tile){ canvas.width=n*tile+1; canvas.height=n*tile+1; }
function drawSpriteInTile(ctx,img,x,y,tile,padRatio=0.1){
  const pad=tile*padRatio, availW=tile-2*pad, availH=tile-2*pad;
  const iw=img.naturalWidth||img.width, ih=img.naturalHeight||img.height; if(!iw||!ih) return;
  const scale=Math.min(availW/iw, availH/ih);
  const w=Math.floor(iw*scale), h=Math.floor(ih*scale);
  const dx=x+(tile-w)/2, dy=y+(tile-h)/2;
  ctx.drawImage(img,dx,dy,w,h);
}

/* ---------------- Assets ---------------- */
const ASSETS={
  ground:new Image(), wall:new Image(), coin:new Image(),
  fire:new Image(),   water:new Image(),
  player0:new Image(), player1:new Image()
};
ASSETS.ground.src='src/imgs/ground.png';
ASSETS.wall.src  ='src/imgs/wall.png';
ASSETS.coin.src  ='src/imgs/coin.png';
ASSETS.fire.src  ='src/imgs/fire.png';
ASSETS.water.src ='src/imgs/water.png';
ASSETS.player0.src='src/imgs/player0.png';
ASSETS.player1.src='src/imgs/player1.png';

let assetsReady=false;
const waitForAssets=Promise.all(Object.values(ASSETS).map(img=>new Promise(res=>{
  if(img.complete) return res(); img.onload=()=>res(); img.onerror=()=>res();
}))).then(()=>assetsReady=true);

/* ---------------- State ---------------- */
const elSize = document.getElementById('size');
const elBuild= document.getElementById('build');
const elMatrix=document.getElementById('matrix');
const elRender=document.getElementById('render');
const elTile  = document.getElementById('tileSize');
const elErr   = document.getElementById('error');
const elDl    = document.getElementById('download');

const elStart = document.getElementById('startVec');
const elMoves = document.getElementById('movesVec');
const elPlay  = document.getElementById('play');
const elRestart=document.getElementById('restart');
const elPlayerSel=document.getElementById('playerSel');
const elStepMs=document.getElementById('stepMs');

const elScore = document.getElementById('score');
const elCoinsLeft=document.getElementById('coinsLeft');
const elMsg   = document.getElementById('msg');
const elStateTxt=document.getElementById('stateTxt');

const elLevelSelect=document.getElementById('levelSelect');

const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha:false });

const elOverlay = document.getElementById('overlay');

let baseMatrix = [];      // mapa original (incluye monedas)
let playMatrix = [];      // mapa mutable (monedas se remueven)
let n = 10, tile = 28;
let score = 0;
let coinsTotal = 0;
let playerPos = null;     // {x,y} o null
let lastN = 10;
let playing = false;

/* ---------------- Rendering ---------------- */
function countCoins(m){ let k=0; for(const row of m) for(const v of row) if(v===2) k++; return k; }
function drawGrid(ctx,n,tile){
  const cs=getComputedStyle(document.documentElement);
  const colGrid=cs.getPropertyValue('--grid').trim();
  ctx.strokeStyle=colGrid; ctx.lineWidth=1;
  for(let c=0;c<=n;c++){ const X=Math.round(c*tile)+0.5; ctx.beginPath(); ctx.moveTo(X,0); ctx.lineTo(X,n*tile); ctx.stroke(); }
  for(let r=0;r<=n;r++){ const Y=Math.round(r*tile)+0.5; ctx.beginPath(); ctx.moveTo(0,Y); ctx.lineTo(n*tile,Y); ctx.stroke(); }
}
function renderBoard(){
  ctx.imageSmoothingEnabled=false;
  ctx.clearRect(0,0,canvas.width,canvas.height);

  for(let r=0;r<n;r++){
    for(let c=0;c<n;c++){
      const v=playMatrix[r][c];
      const x=c*tile, y=r*tile;

      if(v===1){ drawSpriteInTile(ctx, ASSETS.wall, x,y,tile,0.0); continue; }
      if(v===3){ drawSpriteInTile(ctx, ASSETS.fire, x,y,tile,0.0); continue; }
      if(v===4){ drawSpriteInTile(ctx, ASSETS.water,x,y,tile,0.0); continue; }

      drawSpriteInTile(ctx, ASSETS.ground, x,y,tile,0.0);
      if(v===2){ drawSpriteInTile(ctx, ASSETS.coin, x,y,tile,0.12); }
    }
  }

  if(playerPos){
    const x = playerPos.x * tile, y = playerPos.y * tile;
    const which = elPlayerSel.value === '1' ? ASSETS.player1 : ASSETS.player0;
    drawSpriteInTile(ctx, which, x, y, tile, 0.05);
  }

  drawGrid(ctx,n,tile);
}

/* ---------------- Overlay helpers ---------------- */
function showOverlay(text='Mapa completo — ¡Bien hecho!'){
  elOverlay.textContent = text;
  elOverlay.classList.add('show');
}
function hideOverlay(){
  elOverlay.classList.remove('show');
}

/* ---------------- Game logic ---------------- */
function coordFromStartInput(n){
  const {x, y} = parseVec2(elStart.value);
  let cx = (x>=1 && y>=1) ? x-1 : x;
  let cy = (x>=1 && y>=1) ? y-1 : y;
  cx = clampInt(cx, 0, n-1);
  cy = clampInt(cy, 0, n-1);
  return {x:cx, y:cy};
}
function tryCollect(x,y){ if(playMatrix[y][x]===2){ playMatrix[y][x]=0; score++; } }
function isFatalCell(v){ return v===3 || v===4; }
function isBlocked(v){ return v===1; }
function updateScoreUI(){
  elScore.textContent = String(score);
  const left = Math.max(0, coinsTotal - score);
  elCoinsLeft.textContent = String(left);
}

/* Simulación animada */
function sleep(ms){ return new Promise(res=>setTimeout(res, ms)); }

async function playAnimated(){
  if(playing) return;
  elErr.textContent=''; elMsg.className='banner'; elMsg.textContent='';
  hideOverlay();

  let moves;
  try{
    const start = coordFromStartInput(n);
    moves = parseMoves(elMoves.value);
    playerPos = {x:start.x, y:start.y};
  }catch(e){ elErr.textContent = e.message || String(e); return; }

  const startCell = playMatrix[playerPos.y][playerPos.x];
  if(isFatalCell(startCell)){
    renderBoard(); updateScoreUI();
    showBanner('Fin del juego — Puntaje: '+score, false);
    elRestart.style.display='inline-block';
    return;
  }
  tryCollect(playerPos.x, playerPos.y);
  renderBoard(); updateScoreUI();

  const stepMs = clampInt(Number(elStepMs.value)||150, 30, 2000);
  setPlaying(true);

  for(const m of moves){
    let nx = playerPos.x, ny = playerPos.y;
    if(m===1) ny--; else if(m===2) nx++; else if(m===3) ny++; else if(m===4) nx--;

    if(nx<0 || ny<0 || nx>=n || ny>=n){ await sleep(stepMs); continue; }
    if(isBlocked(playMatrix[ny][nx])){ await sleep(stepMs); continue; }

    playerPos.x = nx; playerPos.y = ny;
    const cell = playMatrix[ny][nx];

    renderBoard(); updateScoreUI();
    await sleep(stepMs);

    if(isFatalCell(cell)){
      renderBoard(); updateScoreUI();
      showBanner('Fin del juego — Puntaje: '+score, false);
      elRestart.style.display='inline-block';
      setPlaying(false);
      return;
    }

    tryCollect(nx, ny);
    renderBoard(); updateScoreUI();

    if(score >= coinsTotal && coinsTotal>0){
      // Nivel completado: mantener último frame (no resetear mapa ni jugador)
      showOverlay('Mapa completo — ¡Bien hecho!');
      showBanner('Mapa completo — ¡Bien hecho!', true);
      elRestart.style.display='inline-block';
      setPlaying(false);
      return;
    }
  }
  setPlaying(false);
}

function showBanner(text, success){
  elMsg.textContent = text;
  elMsg.className = 'banner show ' + (success ? 'success' : 'fail');
}
function setPlaying(on){
  playing = on;
  elStateTxt.textContent = on ? 'jugando' : 'listo';
  elPlay.disabled = on;
  elRestart.disabled = on;
  elBuild.disabled = on;
  elRender.disabled = on;
  elDl.disabled = on;
  elMatrix.disabled = on;
  elStart.disabled = on;
  elMoves.disabled = on;
  elTile.disabled = on;
  elSize.disabled = on;
  elPlayerSel.disabled = on;
  elStepMs.disabled = on;
  elLevelSelect.disabled = on;
}

/* ---------------- Nivel predefinido → cargar ---------------- */
function matrixToText(m){ return m.map(row=>row.join(' ')).join('\n'); }
function loadPresetLevel(key){
  const mat = PRESET_LEVELS[key];
  if(!mat){ showBanner('Nivel no disponible.', false); return; }
  n = mat.length;
  elSize.value = String(n);
  baseMatrix = mat.map(row=>row.slice());
  elMatrix.value = matrixToText(baseMatrix);
  initFromTextarea();
  showBanner(`Nivel ${key} cargado.`, true);
}

/* ---------------- Wiring & lifecycle ---------------- */
function demoMatrix(size){
  return Array.from({length:size},(_,r)=>
    Array.from({length:size},(_,c)=>{
      if(r===0||c===0||r===size-1||c===size-1) return 1;
      if(r===c) return 2;
      if(r+c===size-1) return 3;
      if(r===Math.floor(size/2)) return 4;
      return 0;
    })
  );
}

function buildTemplate(){
  n = clampInt(Number(elSize.value)||10, 1, 100);
  elSize.value = String(n);
  baseMatrix = demoMatrix(n);
  elMatrix.value = matrixToText(baseMatrix);
  initFromTextarea();
}

function initFromTextarea(){
  if(playing) return;
  elErr.textContent='';
  hideOverlay();
  try{
    n = clampInt(Number(elSize.value)||10, 1, 100);
    tile = clampInt(Number(elTile.value)||28, 6, 80);
    baseMatrix = parseMatrix(elMatrix.value, n);
    playMatrix = deepCopy(baseMatrix);
    coinsTotal = countCoins(baseMatrix);
    score = 0;
    playerPos = null;
    elRestart.style.display='none';
    elMsg.className='banner'; elMsg.textContent='';
    updateScoreUI();
    resizeCanvasForMatrix(canvas, n, tile);
    if(!assetsReady){ renderBoard(); waitForAssets.then(renderBoard); } else { renderBoard(); }
    lastN = n;
  }catch(e){ elErr.textContent = e.message || String(e); }
}

function resetCoinsAndPlayer(){
  playMatrix = deepCopy(baseMatrix);
  score = 0;
  playerPos = null;
  elRestart.style.display='none';
  updateScoreUI();
  hideOverlay();
  renderBoard();
}

function downloadPNG(){
  if(canvas.width===0) return;
  canvas.toBlob(blob=>{
    if(!blob) return;
    const a=document.createElement('a');
    const url=URL.createObjectURL(blob);
    a.href=url; a.download=`board_${lastN}x${lastN}.png`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  },'image/png');
}

/* Eventos */
document.getElementById('download').addEventListener('click', downloadPNG);
document.getElementById('render').addEventListener('click', initFromTextarea);
document.getElementById('build').addEventListener('click', buildTemplate);
document.getElementById('tileSize').addEventListener('change', ()=>{ tile=clampInt(Number(elTile.value)||28,6,80); resizeCanvasForMatrix(canvas,n,tile); renderBoard(); });
elMatrix.addEventListener('keydown', e=>{ if((e.ctrlKey||e.metaKey) && e.key==='Enter') initFromTextarea(); });
document.getElementById('play').addEventListener('click', ()=>{ playAnimated().catch(err=>{ elErr.textContent=String(err); setPlaying(false); }); });
document.getElementById('restart').addEventListener('click', ()=>{ resetCoinsAndPlayer(); showBanner('Juego reiniciado. Monedas restauradas.', true); });

elLevelSelect.addEventListener('change', (e)=>{ const key=e.target.value; if(key) loadPresetLevel(key); });

/* Primera carga */
buildTemplate();
</script>
</body>
</html>
